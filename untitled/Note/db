use candybear_db

CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(50) UNIQUE NOT NULL COMMENT 'QQ号',
    nickname VARCHAR(100) COMMENT '最后看到的昵称',
    total_messages INT DEFAULT 0 COMMENT '总消息数',
    last_active TIMESTAMP NULL COMMENT '最后活跃时间',
    first_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_last_active (last_active DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE messages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    group_id VARCHAR(50) COMMENT '群号，私聊为NULL',
    user_id VARCHAR(50) NOT NULL COMMENT '发送者QQ',
    content TEXT NOT NULL COMMENT '消息内容',
    is_robot_reply BOOLEAN DEFAULT FALSE COMMENT '是否为机器人回复',
    is_private BOOLEAN DEFAULT FALSE COMMENT '是否为私聊',
    reply_to_id BIGINT COMMENT '回复的消息ID',
    session_id VARCHAR(100) COMMENT 'BaiLianService的sessionId',
    topics VARCHAR(255) COMMENT '话题标签，逗号分隔',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_group_time (group_id, created_at DESC),
    INDEX idx_user_session (user_id, session_id),
    INDEX idx_robot_reply (is_robot_reply, created_at),
    INDEX idx_session (session_id),
    INDEX idx_created_at (created_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE conversation_threads (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    thread_key VARCHAR(100) UNIQUE NOT NULL COMMENT 'BaiLianService的group_X_user_Y格式',
    group_id VARCHAR(50),
    user_id VARCHAR(50) NOT NULL,
    last_bot_reply TEXT COMMENT 'AI上次完整回复',
    last_interaction TIMESTAMP NULL COMMENT '最后交互时间',
    interaction_count INT DEFAULT 1 COMMENT '交互次数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_thread_key (thread_key),
    INDEX idx_group_user (group_id, user_id),
    INDEX idx_last_interaction (last_interaction DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE active_reply_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    group_id VARCHAR(50) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    message_content TEXT,
    decision VARCHAR(20) COMMENT 'reply/no_reply',
    decision_reason VARCHAR(100) COMMENT '决策原因',
    confidence DECIMAL(4,3) COMMENT '决策置信度',
    replied_content TEXT COMMENT '实际回复内容（如果回复了）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_group_time (group_id, created_at DESC),
    INDEX idx_decision (decision, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;



